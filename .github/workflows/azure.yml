name: Deploy to Azure

on:
  push:
    branches: [ "main" ]

env:
  AZURE_REGION: eastus
  RESOURCE_GROUP: devops-assignment-prod-rg
  BACKEND_APP: devops-assignment-prod-backend
  FRONTEND_APP: devops-assignment-prod-frontend

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get ACR Name
      id: acr
      run: |
        ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
        echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
        echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

    - name: Login to ACR
      run: |
        az acr login --name ${{ steps.acr.outputs.acr_name }}

    - name: Build and Push Backend
      id: build-backend
      run: |
        docker build -t ${{ steps.acr.outputs.login_server }}/backend:${{ github.sha }} ./backend
        docker push ${{ steps.acr.outputs.login_server }}/backend:${{ github.sha }}
        echo "image=${{ steps.acr.outputs.login_server }}/backend:${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Deploy Backend to Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        containerAppName: ${{ env.BACKEND_APP }}
        imageToDeploy: ${{ steps.build-backend.outputs.image }}

    - name: Get Backend URL
      id: get-url
      run: |
        BACKEND_FQDN=$(az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
        echo "backend_url=https://$BACKEND_FQDN" >> $GITHUB_OUTPUT

    - name: Build and Push Frontend
      id: build-frontend
      run: |
        docker build --build-arg NEXT_PUBLIC_API_URL=${{ steps.get-url.outputs.backend_url }} -t ${{ steps.acr.outputs.login_server }}/frontend:${{ github.sha }} ./frontend
        docker push ${{ steps.acr.outputs.login_server }}/frontend:${{ github.sha }}
        echo "image=${{ steps.acr.outputs.login_server }}/frontend:${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Deploy Frontend to Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        containerAppName: ${{ env.FRONTEND_APP }}
        imageToDeploy: ${{ steps.build-frontend.outputs.image }}

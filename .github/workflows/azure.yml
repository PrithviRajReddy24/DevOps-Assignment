name: Deploy to Azure

on:
  push:
    branches: [ "main" ]

env:
  AZURE_REGION: eastus
  RESOURCE_GROUP: devops-assignment-prod-rg
  BACKEND_APP: devops-assignment-prod-backend
  FRONTEND_APP: devops-assignment-prod-frontend

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get ACR Credentials
      id: acr
      run: |
        ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
        ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer -o tsv)
        ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query username -o tsv)
        ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
        echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
        echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT
        echo "::add-mask::$ACR_PASSWORD"
        echo "acr_username=$ACR_USERNAME" >> $GITHUB_OUTPUT
        echo "acr_password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

    - name: Login to ACR
      run: |
        docker login ${{ steps.acr.outputs.login_server }} -u ${{ steps.acr.outputs.acr_username }} -p ${{ steps.acr.outputs.acr_password }}

    - name: Configure ACR on Container Apps
      run: |
        az containerapp registry set --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} \
          --server ${{ steps.acr.outputs.login_server }} \
          --username ${{ steps.acr.outputs.acr_username }} \
          --password ${{ steps.acr.outputs.acr_password }}
        az containerapp registry set --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} \
          --server ${{ steps.acr.outputs.login_server }} \
          --username ${{ steps.acr.outputs.acr_username }} \
          --password ${{ steps.acr.outputs.acr_password }}

    - name: Build and Push Backend
      id: build-backend
      run: |
        docker build -t ${{ steps.acr.outputs.login_server }}/backend:${{ github.sha }} ./backend
        docker push ${{ steps.acr.outputs.login_server }}/backend:${{ github.sha }}

    - name: Deploy Backend
      run: |
        az containerapp update --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ steps.acr.outputs.login_server }}/backend:${{ github.sha }}

    - name: Get Backend URL
      id: get-url
      run: |
        BACKEND_FQDN=$(az containerapp show --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
        echo "backend_url=https://$BACKEND_FQDN" >> $GITHUB_OUTPUT

    - name: Build and Push Frontend
      id: build-frontend
      run: |
        docker build --build-arg NEXT_PUBLIC_API_URL=${{ steps.get-url.outputs.backend_url }} -t ${{ steps.acr.outputs.login_server }}/frontend:${{ github.sha }} ./frontend
        docker push ${{ steps.acr.outputs.login_server }}/frontend:${{ github.sha }}

    - name: Deploy Frontend
      run: |
        az containerapp update --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ steps.acr.outputs.login_server }}/frontend:${{ github.sha }}
